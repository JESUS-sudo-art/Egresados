# Cambios Realizados - 20 de Noviembre de 2025

## 1. Sistema de Dimensiones para Encuestas

### Objetivo
Implementar un sistema de agrupación de preguntas por dimensiones para organizar mejor las encuestas, usando como ejemplo la "encuesta laboral".

### Archivos Creados

#### Modelos y Migraciones
- **`app/Models/Dimension.php`**: Modelo para gestionar dimensiones de encuestas
  - Relación con `Encuesta` (belongsTo)
  - Relación con `Pregunta` (hasMany)
  - Campos: `id`, `nombre`, `descripcion`, `orden`, `encuesta_id`

- **Migraciones existentes actualizadas**:
  - `database/migrations/2025_10_13_202528_create_dimension_table.php`
  - `database/migrations/2025_10_13_202531_add_foreign_keys_to_dimension_table.php`
  - `database/migrations/2025_10_13_202528_create_pregunta_table.php` (añade `dimension_id`)
  - `database/migrations/2025_10_13_202531_add_foreign_keys_to_pregunta_table.php`

#### Controladores
- **`app/Http/Controllers/DimensionController.php`**: CRUD completo de dimensiones
  - `index($encuestaId)`: Lista dimensiones de una encuesta con contador de preguntas
  - `store(Request, $encuestaId)`: Crea nueva dimensión
  - `update(Request, $id)`: Actualiza dimensión existente
  - `destroy(Request, $id)`: Elimina dimensión con estrategia de reasignación
    - Parámetro `reassign_to`: permite reasignar preguntas a otra dimensión o dejarlas sin dimensión (null)
    - Validación: la dimensión destino debe pertenecer a la misma encuesta

- **`app/Http/Controllers/AdminUnidadController.php`**: Extendido para soportar dimensiones
  - `storePregunta()`: Ahora acepta `dimension_id` opcional y valida que pertenezca a la encuesta
  - `updatePregunta()`: Actualiza `dimension_id` con validación

- **`app/Http/Controllers/EncuestaController.php`**: Modificado para agrupar por dimensiones
  - `show()`: Eager-load de dimensiones, agrupa preguntas por dimensión
  - `misRespuestas()`: Muestra respuestas agrupadas por dimensión
  - Añade categoría "Otras Preguntas" para preguntas sin dimensión asignada

#### Rutas
**`routes/web.php`**: Nuevas rutas para gestión de dimensiones
```php
Route::get('admin-unidad/encuestas/{encuestaId}/dimensiones', [DimensionController::class, 'index'])
Route::post('admin-unidad/encuestas/{encuestaId}/dimensiones', [DimensionController::class, 'store'])
Route::put('admin-unidad/dimensiones/{id}', [DimensionController::class, 'update'])
Route::delete('admin-unidad/dimensiones/{id}', [DimensionController::class, 'destroy'])
```

#### Vistas (Frontend)
- **`resources/js/pages/modules/AdminUnidad.vue`**: Nueva pestaña "Dimensiones"
  - Selector de encuesta
  - Formulario para crear/editar dimensiones (nombre, descripción, orden)
  - Listado de dimensiones con contador de preguntas
  - Botón "Ver Preguntas" para gestionar preguntas de cada dimensión
  - Panel inferior para:
    - Crear preguntas directamente en una dimensión
    - Editar preguntas (texto, tipo, orden)
    - Eliminar preguntas
    - Nota: Opciones se gestionan desde pestaña "Preguntas"
  - Selector de reasignación al eliminar dimensiones

- **`resources/js/pages/modules/ContestarEncuesta.vue`**: Actualizado para mostrar preguntas agrupadas por dimensión
  - Iteración por `encuesta.dimensiones` en lugar de `encuesta.preguntas`
  - Renderizado de título de dimensión antes de sus preguntas

- **`resources/js/pages/modules/VerRespuestas.vue`**: Actualizado para mostrar respuestas agrupadas por dimensión

#### Scripts de Utilidad
Scripts CLI PHP en la raíz del proyecto para operaciones manuales:

1. **`assign_dimensions_encuesta_6.php`**: Asigna dimensiones y preguntas para encuesta 6
2. **`edit_dimension.php`**: Edita atributos de una dimensión específica
3. **`reassign_question_dimension.php`**: Reasigna una pregunta a otra dimensión
4. **`bulk_reassign_dimensions.php`**: Reasignación masiva (auto round-robin o CSV)
5. **`create_dimensions.php`**: Crea dimensión individual o múltiples vía CSV
6. **`delete_dimension_move.php`**: Elimina dimensión y reasigna/anula preguntas

### Flujo de Trabajo con Dimensiones
1. Crear encuesta (pestaña "Gestor de Encuestas")
2. Ir a pestaña "Dimensiones"
3. Seleccionar la encuesta
4. Crear las dimensiones necesarias (nombre, descripción, orden)
5. Para cada dimensión, pulsar "Ver Preguntas"
6. Crear preguntas directamente en la dimensión
7. Editar/eliminar preguntas según sea necesario
8. Las opciones de preguntas se gestionan desde la pestaña "Preguntas"

---

## 2. Corrección: Perfil y Datos (Bug de Sobrescritura)

### Problema Detectado
Al guardar datos personales en "Perfil y Datos", se sobrescribía siempre el primer egresado de la base de datos porque `PerfilController::index()` usaba `Egresado::first()` en lugar del egresado del usuario autenticado.

### Solución Implementada
**`app/Http/Controllers/PerfilController.php`**: Refactorización completa con autenticación

#### Cambios en `index()`
- Obtiene el egresado asociado al `email` del usuario autenticado
- Si no existe egresado, crea uno automáticamente con datos básicos del usuario
- Carga relaciones: genero, estadoCivil, estatus, carreras

#### Cambios en `updateDatosPersonales()`
- Valida que el egresado a actualizar pertenezca al usuario autenticado
- Usa doble condición: `where('id', $id)->where('email', $user->email)`

#### Cambios en `storeEmpleo()`
- Verifica que el `egresado_id` pertenezca al usuario autenticado antes de crear empleo

#### Cambios en `updateEmpleo()` y `deleteEmpleo()`
- Usa `whereHas('egresado')` para verificar que el empleo pertenece al egresado del usuario autenticado

### Archivos Modificados
- `app/Http/Controllers/PerfilController.php`

---

## 3. Corrección: Dashboard para Nuevos Usuarios

### Problema
Usuarios recién registrados sin egresado asociado causaban errores al acceder al dashboard.

### Solución
**`app/Http/Controllers/DashboardController.php`**:
- Si un usuario autenticado (Estudiante o Egresado) no tiene registro en tabla `egresado`, se crea automáticamente
- Campos iniciales: `email`, `nombre` (del usuario), `estatus_id` = 1

---

## 4. Corrección: Registro de Usuarios

### Problema
Error `Class 'App\Actions\Fortify\Rules\Password' not found` al intentar registrarse.

### Solución
**`app/Actions/Fortify/CreateNewUser.php`**: Añadidos imports faltantes
```php
use Illuminate\Support\Facades\Hash;
use Illuminate\Validation\Rules;
```

---

## 5. Limpieza de Datos de Prueba

### Acción
Creado y ejecutado script `limpiar_estudiantes_prueba.php` para eliminar registros de egresados con "Estudiante" en el nombre.

### Registros Eliminados
- TEST2321 - Estudiante (estudiante@example.com)
- TEST6714 - Estudiante (el4643874@gmail.com)
- TEST1001 - Estudiante (estudiante.test1@example.com)
- TEST1002 - Estudiante (estudiante.test2@example.com)
- TEST1003 - Estudiante (estudiante.test3@example.com)

### Resultado
Catálogo limpio con solo egresados reales (elizabeth Lopez y ortega garcia).

---

## Resumen de Archivos Modificados

### Backend (PHP)
- ✅ `app/Models/Dimension.php` (nuevo)
- ✅ `app/Models/Pregunta.php` (relación dimension)
- ✅ `app/Models/Encuesta.php` (relación dimensiones)
- ✅ `app/Http/Controllers/DimensionController.php` (nuevo)
- ✅ `app/Http/Controllers/AdminUnidadController.php` (soporte dimension_id)
- ✅ `app/Http/Controllers/EncuestaController.php` (agrupación por dimensión)
- ✅ `app/Http/Controllers/PerfilController.php` (autenticación y auto-creación)
- ✅ `app/Http/Controllers/DashboardController.php` (auto-creación egresado)
- ✅ `app/Actions/Fortify/CreateNewUser.php` (imports corregidos)
- ✅ `routes/web.php` (rutas de dimensiones)

### Frontend (Vue)
- ✅ `resources/js/pages/modules/AdminUnidad.vue` (pestaña Dimensiones)
- ✅ `resources/js/pages/modules/ContestarEncuesta.vue` (renderizado por dimensión)
- ✅ `resources/js/pages/modules/VerRespuestas.vue` (respuestas por dimensión)

### Scripts de Utilidad
- ✅ `assign_dimensions_encuesta_6.php`
- ✅ `edit_dimension.php`
- ✅ `reassign_question_dimension.php`
- ✅ `bulk_reassign_dimensions.php`
- ✅ `create_dimensions.php`
- ✅ `delete_dimension_move.php`
- ✅ `limpiar_estudiantes_prueba.php`

---

## Validaciones y Testing

### Validaciones Implementadas
1. **Dimensión-Encuesta**: Al crear/actualizar pregunta, valida que dimension_id pertenezca a la encuesta
2. **Usuario-Egresado**: Verificación en todas las operaciones de perfil y empleo
3. **Reasignación de dimensiones**: Validación que dimensión destino pertenece a la misma encuesta

### Syntax Check
Todos los archivos PHP validados sin errores de sintaxis:
```bash
php -l app/Http/Controllers/DimensionController.php
php -l app/Http/Controllers/AdminUnidadController.php
php -l app/Http/Controllers/PerfilController.php
php -l app/Http/Controllers/DashboardController.php
php -l app/Actions/Fortify/CreateNewUser.php
```

---

## Pendientes (Opcional)

- [ ] **Seeder plantilla futuras encuestas**: Script o seeder base que genere dimensiones iniciales para nuevas encuestas tipo "laboral"
- [ ] **Selector de dimensión en edición**: Permitir cambiar la dimensión de una pregunta existente sin eliminar/recrear
- [ ] **Interfaz de gestión de opciones en tab Dimensiones**: Duplicar lógica de opciones o integrar en panel de preguntas por dimensión

---

## Notas Técnicas

### Relaciones de Base de Datos
```
Encuesta (1) ←→ (N) Dimension
Dimension (1) ←→ (N) Pregunta
Pregunta (1) ←→ (N) Opcion
```

### Estrategia de Eliminación de Dimensiones
Al eliminar una dimensión, se puede:
1. **No especificar `reassign_to`**: Las preguntas quedan con `dimension_id = null` (categoría "Otras Preguntas")
2. **`reassign_to=null`**: Explícitamente quitar dimensión de las preguntas
3. **`reassign_to=<id>`**: Reasignar preguntas a otra dimensión de la misma encuesta

### Auto-creación de Egresados
Cuando un usuario autenticado accede a:
- `/dashboard` (si es Estudiante o Egresado)
- `/perfil-datos`

Y no tiene registro en `egresado`, se crea automáticamente con:
- `email`: del usuario
- `nombre`: del campo `name` del usuario
- `apellidos`: cadena vacía
- `estatus_id`: 1 (por defecto)

---

## Comandos Útiles

### Ver rutas de dimensiones
```bash
php artisan route:list --name=dimension
```

### Limpiar caché de rutas
```bash
php artisan route:clear
php artisan config:clear
```

### Ejecutar scripts de utilidad
```bash
php assign_dimensions_encuesta_6.php
php create_dimensions.php <encuesta_id> nombre="Título" descripcion="Desc" orden=1
php bulk_reassign_dimensions.php <encuesta_id> auto
```

---

## Estado Final del Sistema

✅ Sistema de dimensiones completamente funcional  
✅ CRUD de dimensiones integrado en Admin Unidad  
✅ Preguntas agrupadas por dimensión en frontend  
✅ Perfil y datos con autenticación por usuario  
✅ Dashboard con auto-creación de perfiles  
✅ Registro de usuarios corregido  
✅ Base de datos limpia (sin registros de prueba)  

**Sistema listo para producción con gestión completa de encuestas por dimensiones.**
