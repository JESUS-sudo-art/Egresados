# Cambios Realizados - 25 de Noviembre 2025

## Resumen
Se realizaron múltiples correcciones y mejoras al sistema de gestión de egresados, enfocándose en la navegación, roles, permisos y formularios de encuestas.

---

## 1. Corrección de Navegación para Encuestas

### Problema
Después de cerrar sesión y volver a entrar, las encuestas no aparecían en el menú lateral para los egresados/estudiantes.

### Solución
**Archivo modificado:** `resources/js/components/AppSidebar.vue`

Se agregaron enlaces directos a las encuestas en el menú lateral:
- **Encuesta Pre-Egreso** - Para Egresados y Estudiantes
- **Encuesta de Egreso** - Para Egresados y Estudiantes  
- **Encuesta Laboral** - Solo para Egresados
- **Acuses de Seguimiento** - Para Egresados y Estudiantes

```typescript
// Encuestas solo para Egresados y Estudiantes (NO para Admin General)
if (isEgresado.value || isEstudiante.value) {
    items.push({ title: 'Encuesta Pre-Egreso', href: '/encuesta-preegreso', icon: BookOpen });
    items.push({ title: 'Encuesta de Egreso', href: '/encuesta-egreso', icon: BookOpen });
}
if (isEgresado.value) {
    items.push({ title: 'Encuesta Laboral', href: '/encuesta-laboral', icon: BookOpen });
}
if (isEgresado.value || isEstudiante.value) {
    items.push({ title: 'Acuses de Seguimiento', href: '/acuses-seguimiento', icon: Shield });
}
```

**Resultado:** Las encuestas ahora son visibles permanentemente en el menú para usuarios con roles apropiados.

---

## 2. Creación del Rol "Estudiantes"

### Problema
Al registrarse como estudiante, se producía error: `RoleDoesNotExist: There is no role named 'Estudiantes' for guard 'web'`

### Solución
**Script creado:** `crear_rol_estudiantes.php`

Se creó el rol faltante en la base de datos usando Spatie Permission:

```php
$role = Role::firstOrCreate(['name' => 'Estudiantes']);
```

**Resultado:** 
- Rol `Estudiantes` creado con ID 5
- Sistema ahora soporta 5 roles: Administrador general, Administrador de unidad, Administrador academico, Egresados, Estudiantes

---

## 3. Corrección de Permisos en Rutas de Perfil

### Problema
Error 403 al acceder a `/perfil-datos` como estudiante.

### Solución
**Archivo modificado:** `routes/web.php`

Se agregó middleware de autenticación y roles a las rutas API del perfil:

```php
// Rutas API para Perfil
Route::post('perfil/datos-personales', [PerfilController::class, 'updateDatosPersonales'])
    ->name('perfil.update-datos')
    ->middleware(['auth', 'verified', 'role:Estudiantes,Egresados,Administrador general']);

Route::post('perfil/empleos', [PerfilController::class, 'storeEmpleo'])
    ->name('perfil.store-empleo')
    ->middleware(['auth', 'verified', 'role:Estudiantes,Egresados,Administrador general']);

Route::put('perfil/empleos/{id}', [PerfilController::class, 'updateEmpleo'])
    ->name('perfil.update-empleo')
    ->middleware(['auth', 'verified', 'role:Estudiantes,Egresados,Administrador general']);

Route::delete('perfil/empleos/{id}', [PerfilController::class, 'deleteEmpleo'])
    ->name('perfil.delete-empleo')
    ->middleware(['auth', 'verified', 'role:Estudiantes,Egresados,Administrador general']);
```

**Resultado:** Estudiantes pueden ahora actualizar su perfil correctamente.

---

## 4. Asignación Manual de Rol al Usuario Eliot

### Problema
Usuario `eliot` (el4643874@gmail.com) registrado sin rol asignado porque el rol `Estudiantes` no existía al momento del registro.

### Solución
**Script creado:** `asignar_rol_eliot.php`

```php
$usuario = User::where('email', 'el4643874@gmail.com')->first();
$usuario->assignRole('Estudiantes');
```

**Resultado:** Usuario puede ahora acceder a todas las funciones de estudiante.

---

## 5. Corrección de Guardado de Género en Cédula Pre-Egreso

### Problema
Al guardar la cédula de pre-egreso, el campo `genero_id` no se actualizaba en la tabla `egresado` (quedaba en NULL).

### Solución
**Archivo modificado:** `app/Http/Controllers/CedulaPreegresoController.php`

Se agregó mapeo del campo `sexo` al campo `genero_id`:

```php
// Mapear sexo a genero_id (1=Masculino, 2=Femenino, 3=No binario)
$generoId = null;
if ($validated['sexo'] === 'Hombre') {
    $generoId = 1;
} elseif ($validated['sexo'] === 'Mujer') {
    $generoId = 2;
} elseif ($validated['sexo'] === 'Otro') {
    $generoId = 3;
}

// Actualizar datos del egresado
$egresado->update([
    'nombre' => $validated['nombres'],
    'apellidos' => $validated['apellido_paterno'] . ' ' . $validated['apellido_materno'],
    'curp' => $validated['curp'],
    'email' => $validated['email'],
    'genero_id' => $generoId,  // ← NUEVO
    // ... resto de campos
]);
```

**Resultado:** El género ahora se guarda correctamente en la tabla egresado.

**Nota:** Los campos `fecha_nacimiento` y `lugar_nacimiento` no están en el formulario actual de la encuesta. Si se requieren, habría que agregarlos al formulario Vue y a la validación.

---

## 6. Creación de Estatus "Estudiante"

### Problema
En el catálogo de estatus solo existía "Egresado", faltaba la opción "Estudiante".

### Solución
**Script creado:** `agregar_estatus_estudiante.php`

```php
$estudiante = CatEstatus::firstOrCreate(['nombre' => 'Estudiante']);
```

**Resultado:** 
- Estatus `Estudiante` creado con ID 2
- Catálogo ahora tiene: Egresado (ID 1) y Estudiante (ID 2)
- Select de estatus en perfil muestra ambas opciones

---

## 7. Filtrado de Encuestas para Admin General

### Problema
Los administradores generales veían las encuestas en su menú lateral, cuando estas solo deberían ser para Egresados y Estudiantes.

### Solución
**Archivo modificado:** `resources/js/components/AppSidebar.vue`

Se removió `isAdminGeneral.value` de las condiciones de las encuestas:

**ANTES:**
```typescript
if (isEgresado.value || isEstudiante.value || isAdminGeneral.value) {
    items.push({ title: 'Encuesta Pre-Egreso', href: '/encuesta-preegreso', icon: BookOpen });
}
```

**DESPUÉS:**
```typescript
if (isEgresado.value || isEstudiante.value) {
    items.push({ title: 'Encuesta Pre-Egreso', href: '/encuesta-preegreso', icon: BookOpen });
}
```

**Resultado:** Administradores generales ya no ven las encuestas en su menú.

---

## 8. Filtrado de Usuarios en Gestión de Roles

### Problema
En la página "Gestión de Roles" aparecían todos los usuarios del sistema, incluyendo Egresados y Estudiantes.

### Solución
**Archivo modificado:** `app/Http/Controllers/UserRoleController.php`

Se agregó filtro para mostrar solo usuarios con roles administrativos:

**ANTES:**
```php
$users = User::with('roles')->get()->map(function ($user) {
    return [
        'id' => $user->id,
        'name' => $user->name,
        'email' => $user->email,
        'roles' => $user->roles->pluck('name'),
    ];
});
```

**DESPUÉS:**
```php
// Solo mostrar usuarios con roles administrativos
$users = User::with('roles')
    ->whereHas('roles', function ($query) {
        $query->whereIn('name', [
            'Administrador general',
            'Administrador de unidad',
            'Administrador academico'
        ]);
    })
    ->get()
    ->map(function ($user) {
        return [
            'id' => $user->id,
            'name' => $user->name,
            'email' => $user->email,
            'roles' => $user->roles->pluck('name'),
        ];
    });
```

**Resultado:** La gestión de roles solo muestra usuarios administrativos, sin incluir Egresados ni Estudiantes.

---

## Scripts de Utilidad Creados

Durante el proceso se crearon varios scripts de diagnóstico y corrección:

1. **`check_roles.php`** - Verifica roles existentes en la base de datos
2. **`crear_rol_estudiantes.php`** - Crea el rol Estudiantes
3. **`verificar_ultimo_usuario.php`** - Verifica el último usuario registrado y sus roles
4. **`asignar_rol_eliot.php`** - Asigna rol Estudiantes a usuario específico
5. **`verificar_curp_duplicado.php`** - Verifica duplicados de CURP (no ejecutado)
6. **`agregar_estatus_estudiante.php`** - Agrega estatus Estudiante al catálogo

---

## Estructura de Roles Final

| Rol | ID | Usuarios Tipo | Acceso a Encuestas |
|-----|-------|--------------|-------------------|
| Administrador general | 1 | Administradores | No |
| Administrador de unidad | 2 | Administradores | No |
| Administrador academico | 3 | Administradores | No |
| Egresados | 4 | Ex-alumnos | Sí (todas) |
| Estudiantes | 5 | Alumnos activos | Sí (Pre-egreso, Egreso, Acuses) |

---

## Tablas de Base de Datos Afectadas

### `roles` (Spatie Permission)
- Se agregó: `Estudiantes` (id: 5)

### `cat_estatus`
- Se agregó: `Estudiante` (id: 2)

### `model_has_roles` (Spatie Permission)
- Se asignó rol Estudiantes a usuario id: 8

### `egresado`
- Ahora se guarda correctamente `genero_id` al llenar cédula pre-egreso
- Campos `fecha_nacimiento` y `lugar_nacimiento` aún no se capturan (requiere agregar al formulario)

---

## Archivos Modificados

1. `resources/js/components/AppSidebar.vue` - Navegación del menú lateral
2. `routes/web.php` - Middleware de rutas API del perfil
3. `app/Http/Controllers/CedulaPreegresoController.php` - Guardado de género
4. `app/Http/Controllers/UserRoleController.php` - Filtrado de usuarios administrativos

---

## Pendientes / Notas

1. **Campos faltantes en Cédula Pre-Egreso:**
   - `fecha_nacimiento` - No está en el formulario actual
   - `lugar_nacimiento` - No está en el formulario actual
   - Si se requieren, hay que agregar campos al componente Vue `EncuestaPreegreso.vue`

2. **Validación de CURP único:**
   - El sistema valida unicidad de CURP en tabla `egresado`
   - Revisar lógica si un mismo CURP puede tener múltiples registros (ej: cambio de estatus Estudiante → Egresado)

3. **Scripts de utilidad:**
   - Los archivos `.php` en la raíz del proyecto pueden ser movidos a una carpeta `scripts/` para mejor organización

---

## Testing Realizado

✅ Registro de nuevo usuario como Estudiante  
✅ Login con rol Estudiantes  
✅ Acceso a "Perfil y datos" como Estudiante  
✅ Guardado de Cédula Pre-Egreso con género  
✅ Visualización del menú lateral con encuestas  
✅ Filtrado de usuarios en Gestión de Roles  
✅ Admin General sin acceso a encuestas en menú  

---

## Comandos Ejecutados

```bash
# Crear rol Estudiantes
docker compose exec php php crear_rol_estudiantes.php

# Verificar usuarios y roles
docker compose exec php php verificar_ultimo_usuario.php

# Asignar rol a usuario específico
docker compose exec php php asignar_rol_eliot.php

# Agregar estatus Estudiante
docker compose exec php php agregar_estatus_estudiante.php
```

---

## Contacto y Soporte

Para cualquier duda o issue relacionado con estos cambios, revisar:
- Logs de Laravel en `storage/logs/laravel.log`
- Tabla `roles` y `model_has_roles` para verificar asignaciones
- Middleware en `routes/web.php` para permisos de rutas
