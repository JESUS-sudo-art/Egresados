# Resumen de Cambios y Trabajo del Día - 24 Nov 2025

## Contexto General
Refactor y alineación de modelos Laravel con convenciones personalizadas de timestamps y soft delete (creado_en, actualizado_en, eliminado_en) para eliminar errores SQL sobre la columna inexistente `deleted_at`. También avance en estabilizar páginas de perfil y módulos administrativos.

## Problemas Principales Abordados
1. Excepciones `Unknown column 'X.deleted_at'` en varias tablas (laboral, tipo_pregunta, etc.).
2. Modelos usando `SoftDeletes` sin columna real de borrado lógico.
3. Modelos con columnas personalizadas pero sin definir constantes (`CREATED_AT`, `UPDATED_AT`, `DELETED_AT`).
4. Error en vista Perfil (`/perfil-datos`) al consultar empleos (tabla `laboral`).

## Modelos Modificados Hoy
| Modelo | Acción | Detalle |
|--------|--------|---------|
| `TipoPregunta` | Ajuste | Añadidas constantes de timestamps y soft delete. |
| `Laboral` | Ajuste | Mapeadas constantes y activado `timestamps`. |
| `UsuarioUnidad` | Ajuste | Mapeadas constantes y activado `timestamps`. |
| `EncuestaLaboral` | Ajuste | Mapeadas constantes y activado `timestamps`. |
| `Dimension` | Ajuste | Mapeadas constantes y activado `timestamps`. |
| `Pregunta` | Ajuste | Mapeadas constantes y activado `timestamps`. |
| `Respuesta` | Limpieza | Removido `SoftDeletes` (tabla sólo tiene `creado_en`). |
| Catálogos previos (`CatGenero`, `CatEstadoCivil`, `CatEstatus`) | Limpieza (antes de hoy parcialmente) | Removido `SoftDeletes` por ausencia de columna de borrado. |
| `Unidad`, `Encuesta`, `Egresado`, `Opcion`, `Generacion`, `Carrera`, `CedulaPreegreso` | Verificados | Ya tenían mapeo correcto o se ajustaron anteriormente. |

## Patrón de Solución
1. Inspección de migración vs. modelo.
2. Si la migración contiene `creado_en`, `actualizado_en`, `eliminado_en` → agregar constantes y `public $timestamps = true`.
3. Si la tabla solo tiene `creado_en` → eliminar `SoftDeletes` y no habilitar timestamps adicionales.
4. Limpiar cachés: `php artisan optimize:clear` tras cada lote de parches.

## Riesgos Mitigados
- Consultas fallidas por `deleted_at` inexistente.
- Inconsistencias futuras en filtrado automático de registros borrados.
- Bloqueos de carga de vistas administrativas y perfil.

## Tareas Pendientes
- Verificar funcionamiento en `/perfil-datos` tras parches (empleos ordenados por `fecha_inicio`).
- Reprobar `/admin-unidad` y `/admin-general` para confirmar ausencia de nuevos errores.
- Revisar cualquier lógica que use explícitamente `deleted_at` en queries manuales (buscar en el código: `deleted_at`).
- Confirmar envío correcto de invitaciones (flujo de correo) cuando el entorno de correo esté configurado.

## Comandos Ejecutados
```
docker compose exec php php artisan optimize:clear
```

## Próximos Pasos Sugeridos
1. Smoke test rápido de rutas clave (perfil, admin general, admin unidad).
2. Añadir pruebas automatizadas para validar que modelos sin `SoftDeletes` no filtran registros (ej. `Respuesta`).
3. Documentar convención institucional de nombres de columnas para nuevos desarrolladores.

## Convenciones Aseguradas
- Soft delete siempre en tablas con `eliminado_en` (mapeado con `const DELETED_AT`).
- Timestamps personalizados: `CREATED_AT = creado_en`, `UPDATED_AT = actualizado_en`.
- Tablas sin `actualizado_en`/`eliminado_en` operan sin `SoftDeletes` y pueden tener `$timestamps=false` si no se requiere actualización automática.

## Observaciones
Eliminamos la fuente repetitiva de errores SQL; cualquier nuevo modelo debe seguir esta plantilla para evitar reintroducir el problema.

---
Generado automáticamente como bitácora del trabajo del día.
